{
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workbookDisplayName": {
        "type": "string",
        "defaultValue": "Identity Governance Workbook",
        "metadata": {
          "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
        }
      },
      "workbookType": {
        "type": "string",
        "defaultValue": "workbook",
        "metadata": {
          "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
        }
      },
      "workbookSourceId": {
        "type": "string",
        "defaultValue": "Azure Monitor",
        "metadata": {
          "description": "The id of resource instance to which the workbook will be associated"
        }
      },
      "workbookId": {
        "type": "string",
        "defaultValue": "[newGuid()]",
        "metadata": {
          "description": "The unique guid for this workbook instance"
        }
      }
    },
    "resources": [
      {
        "name": "[parameters('workbookId')]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2021-03-08",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('workbookDisplayName')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"4c74b48a-391d-4d01-bf53-0802192605dc\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"16164ca1-7a6e-4330-86db-4bc3e82e6b9b\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Azure AD Configuration\",\"subTarget\":\"AzureADConfig\",\"style\":\"link\"},{\"id\":\"a008517b-c421-4924-a4e3-7a0489d7bfba\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Administrative Access\",\"subTarget\":\"Admin\",\"style\":\"link\"},{\"id\":\"51ee84be-d122-4726-9d5b-b75799ccfbf0\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Business User Access\",\"subTarget\":\"BusinessUser\",\"style\":\"link\"},{\"id\":\"85cbb0e4-e431-4132-b709-7a91cce53aca\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Application Access\",\"subTarget\":\"ApplicationAccess\",\"style\":\"link\"}]},\"name\":\"Identity Governance\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Identity Governance Baseline\\r\\n\\r\\n*Placeholder text to describe purpose of workbook*\\r\\n\\r\\n\"},\"name\":\"text - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"Overview\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"Overview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Azure AD Configuration Governance\"},\"name\":\"Overview\"},{\"type\":1,\"content\":{\"json\":\"## Centralized Identity and Authentication\\r\\n\\r\\nStandardize on Azure AD as your organization's identity and authentication platform for Microsoft cloud resources, application, and organizational identities.  In addition, you should synchronize Windows Server Active Directory identities to Azure AD to ensure centralized management.\\r\\n\\r\\nAs soon as you are able, you should migrate on-premises Active Directory based applications to Azure AD.  You can then leverage business to business or business to consumer configurations as needed.\\r\\n\\r\\nLeverage Single Sign-On to allow for other identity providers, such as AWS, to use Azure AD for sign in.\\r\\n\\r\\n\\r\\n### Auditing Resources without Azure AD as a Resource Provider\\r\\n\\r\\nThe below query shows resources where the IdentityProvider tag has been set to a value other than AzureAD.  They should be investigated to build a roadmap for migrating them to Azure AD.\\r\\n\\r\\nReview this information every 3 months, and work with resource owners to build roadmaps for migration.  These owners should also be tagged against the resources.\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where tags.IdentityProvider != \\\"AzureAD\\\"\\n| extend IdentityProvider = tags.IdentityProvider\\n| extend ResourceOwner = tags.Owner\\n| project\\n    ResourceId = tolower(tostring(id)),\\n    IdentityProvider = tags.IdentityProvider,\\n    ResourceOwner = tags.Owner, \\n    Location = tolower(location),\\n    ResourceGroup = resourceGroup,\\n    SubscriptionId = subscriptionId\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"value::all\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceId_0\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceId_0\",\"sortOrder\":1}]},\"name\":\"Tags\"},{\"type\":1,\"content\":{\"json\":\"## Default User Permissions\\r\\n\\r\\nAzure AD should be set up to prevent user registration of applications, restricting access to the Azure AD administration portal, to prevent the connection of user accounts to LinkedIn.\\r\\n\\r\\nIn addition, collaboration settings should be reduced so that only authorized users can grant guest access, guests have limited visibility in to the environment, and guest invitations can only be sent to specific, pre-approved domain.\\r\\n\\r\\n### Auditing\\r\\n\\r\\nYou should audit these configurations every three months.\\r\\n\\r\\nTo audit, navigate to the [Azure AD User Settings blade](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/UserSettings) and confirm the following:\\r\\n\\r\\n- **Users can register applications** is set to *No*.\\r\\n- **Restrict access to Azure AD administration portal** is set to *No*.\\r\\n- **Allow users to connect their work or school account with LinkedIn** is set to *No*.\\r\\n- Select Manage external collaboration settings and then confirm:\\r\\n\\t- **Guest user access restrictions** is set to *Guest user access is restricted to properties of memberships of their own directory objects (most restrictive)*.\\r\\n\\t- **Guest invite restrictions** is set to *Only users assigned to specific admin roles can invite guest users*.\\r\\n\\t- **Collaboration Restrictions** is set to *Allow invitations only to the specified domains (most restrictive)* and then that only domains that you allow to collaborate with you are selected.\"},\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"## Password Management\\r\\n\\r\\nUser passwords should be able to be reset via self-service functions, and passwords should not expire on a schedule.  Passwords should be reset when risk indicates that they may be compromised (see Sign In and User Risk policies below).\\r\\n\\r\\n### Auditing\\r\\n\\r\\nYou should audit these configurations every 3 months.\\r\\n\\r\\nTo audit, review the below configurations:\\r\\n\\r\\n- [Confirm: Passwords Set to Never Expire](https://admin.microsoft.com/AdminPortal/Home?#/featureexplorer/security/PasswordExpiry)\\r\\n- [Confirm: Self-Service Password Reset is enabled](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/PasswordReset)\"},\"name\":\"text - 3\"},{\"type\":1,\"content\":{\"json\":\"## Legacy Authentication\\r\\n\\r\\nLegacy authentication should be disabled.  [This process](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/block-legacy-authentication#directly-blocking-legacy-authentication) provides instructions for creating a conditional access policy that disables legacy authentication.\\r\\n\\r\\n### Auditing\\r\\n\\r\\nYou should review this conditional access policy every 3 months.\\r\\n\\r\\n\"},\"name\":\"text - 4\"},{\"type\":1,\"content\":{\"json\":\"## Sign In and User Risk Policies\\r\\n\\r\\nRisk policies should be used to measure risk for users and their sign-in attempts.  You can review the [instructions for enabling risk policies](https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-configure-risk-policies) to enable these policies.\\r\\n\\r\\n### Auditing\\r\\n\\r\\nOnce enabled, the configuration should be audited every 3 months.\\r\\n\\r\\nIn addition, the following investigations in to Risky Users and Risky Sign-Ins should be reviewed every month:\\r\\n\\r\\n- [Investigate: Risky Users](https://portal.azure.com/#view/Microsoft_AAD_IAM/SecurityMenuBlade/~/RiskyUsers)\\r\\n- [Investigate: Risky Sign-Ins](https://portal.azure.com/#view/Microsoft_AAD_IAM/SecurityMenuBlade/~/RiskySignIns)\"},\"name\":\"text - 5\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AzureADConfig\"},\"name\":\"Azure AD Config\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Administrative Access Governance\\r\\n\"},\"name\":\"text - 0\"},{\"type\":1,\"content\":{\"json\":\"## Emergency Access Accounts\\r\\n\\r\\n### Configuring Emergency Access Accounts\\r\\n\\r\\nCreate two emergency access accounts that are only used in access test and emergencies.  \\r\\n\\r\\n- Implement emergency access accounts by performing the following: [Manage emergency access admin accounts](https://learn.microsoft.com/en-us/azure/active-directory/roles/security-emergency-access)\\r\\n- Secure credentials securely: [Manage emergency access admin accounts](https://learn.microsoft.com/en-us/azure/active-directory/roles/security-emergency-access#store-account-credentials-safely)\\r\\n- Create [specific alerting](https://learn.microsoft.com/en-us/azure/active-directory/roles/security-emergency-access#monitor-sign-in-and-audit-logs) based on login for these accounts\\r\\n\\r\\n### Auditing\\r\\n\\r\\n- Review Sign-in logs for the emergency accounts monthly.\\r\\n- Perform access tests monthly.\"},\"name\":\"text - 1\"},{\"type\":1,\"content\":{\"json\":\"## Global Administrators\\r\\n\\r\\nJust having one global administrator can create lock-out scenarios when someone leaves the company or suffers an account lockout.  In addition, the global administrator role should have its access reviewed frequently. \\r\\n\\r\\nConfirm that you have more than one global administrator, and review global administrators frequently.\\r\\n\\r\\nGlobal administrations should have [Sign-In Logging](https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins) enabled.\\r\\n\\r\\n### Auditing\\r\\n\\r\\nReview the [Members of the Global Administrators group](https://portal.azure.com/#view/Microsoft_AAD_IAM/RoleMenuBlade/~/RoleMembers/objectId/62e90394-69f5-4237-9190-012177145e10/roleName/Global%20administrator/roleTemplateId/62e90394-69f5-4237-9190-012177145e10/adminUnitObjectId//customRole~/false/resourceScope/%2F) monthly.\\r\\n\\r\\n- Ensure that it has at least 2 users.\\r\\n- Ensure that no users who no longer need access are assigned the role.\\r\\n\\r\\n\"},\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"## Privileged Access to Azure\\r\\n\\r\\nAll users with privileged access in to Azure resources should use Privileged Identity Management to provide just in time access.\\r\\n\\r\\n### Auditing\\r\\n\\r\\nPerform [Access Reviews](https://portal.azure.com/#view/Microsoft_AAD_ERM/DashboardBlade/~/Controls) inside of Azure PIM monthly to review access and ensure that PIM is enforced.\\r\\n\\r\\n\"},\"name\":\"text - 3\"},{\"type\":1,\"content\":{\"json\":\"## Management Groups\\r\\n\\r\\nNew subscriptions are placed within the tenant root management group.  However, this can mean that it does not receive the correct policies or correct access.  Instead, subscriptions should be set to be created in a specific management group with roles associated appropriately for new subscriptions.\\r\\n\\r\\nIn addition, creating a management group should require explicit permissions.\\r\\n\\r\\n\\r\\n- Create a management group in the portal: [Quickstart: Create a management group with portal](https://learn.microsoft.com/en-us/azure/governance/management-groups/create-management-group-portal)\\r\\n- Set default management group in portal: [How to protect your resource hierarchy](https://learn.microsoft.com/en-us/azure/governance/management-groups/how-to/protect-resource-hierarchy#set-default-management-group-in-portal)\\r\\n- Enable authorization requirements for creating management groups: [How to protect your resource hierarchy](https://learn.microsoft.com/en-us/azure/governance/management-groups/how-to/protect-resource-hierarchy#setting---require-authorization)\\r\\n\\r\\n### Auditing\\r\\n\\r\\nReview the [Management Group Settings](https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade/~/MGBrowse_settingsItem) every three months.\"},\"name\":\"text - 8\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Admin\"},\"name\":\"Admin Access Governance\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
          "version": "1.0",
          "sourceId": "[parameters('workbookSourceId')]",
          "category": "[parameters('workbookType')]"
        }
      }
    ],
    "outputs": {
      "workbookId": {
        "type": "string",
        "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
      }
    },
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
  }